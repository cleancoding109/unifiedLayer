{
  "pipeline": {
    "name": "unified_customer_cdc_scd2_pipeline",
    "version": "2.0.0",
    "description": "Unified SCD Type 2 Pipeline - merges 3 customer source paths into single unified table"
  },

  "target": {
    "table_name": "unified_customer_scd2",
    "comment": "Unified SCD Type 2 - complete customer history from Greenplum legacy to real-time Kafka CDC",
    "scd_type": 2,
    "keys": ["customer_id"],
    "sequence_by": "event_timestamp",
    "delete_condition": "is_deleted = true",
    "except_columns": [],
    "track_history_except_columns": ["source_system", "ingestion_timestamp", "_version", "source_record_start_dt", "source_record_end_dt"],
    "schema": {
      "customer_id":            {"dtype": "STRING",    "nullable": false, "description": "Unique customer identifier"},
      "customer_name":          {"dtype": "STRING",    "nullable": true,  "description": "Full customer name"},
      "date_of_birth":          {"dtype": "DATE",      "nullable": true,  "description": "Customer date of birth"},
      "email":                  {"dtype": "STRING",    "nullable": true,  "description": "Primary email address"},
      "phone":                  {"dtype": "STRING",    "nullable": true,  "description": "Primary phone number"},
      "state":                  {"dtype": "STRING",    "nullable": true,  "description": "State code (2-letter)"},
      "zip_code":               {"dtype": "STRING",    "nullable": true,  "description": "ZIP/Postal code"},
      "status":                 {"dtype": "STRING",    "nullable": true,  "description": "Customer status (active, inactive, etc.)"},
      "last_login":             {"dtype": "TIMESTAMP", "nullable": true,  "description": "Last login timestamp"},
      "session_count":          {"dtype": "INT",       "nullable": true,  "description": "Total session count"},
      "page_views":             {"dtype": "INT",       "nullable": true,  "description": "Total page views"},
      "is_deleted":             {"dtype": "BOOLEAN",   "nullable": false, "description": "Soft delete flag"},
      "event_timestamp":        {"dtype": "TIMESTAMP", "nullable": false, "description": "Event/change timestamp for SCD2 sequencing"},
      "ingestion_timestamp":    {"dtype": "TIMESTAMP", "nullable": true,  "description": "When record was ingested into Bronze"},
      "source_system":          {"dtype": "STRING",    "nullable": false, "description": "Origin system identifier"},
      "source_record_start_dt": {"dtype": "TIMESTAMP", "nullable": true,  "description": "Original SCD start date from source system"},
      "source_record_end_dt":   {"dtype": "TIMESTAMP", "nullable": true,  "description": "Original SCD end date from source system"},
      "_version":               {"dtype": "LONG",      "nullable": true,  "description": "Source record version"}
    },
    "transforms": {
      "to_date": {
        "description": "Parse string to DATE type",
        "formats": ["yyyy-MM-dd", "MM/dd/yyyy", "dd-MMM-yyyy", "yyyyMMdd"]
      },
      "to_timestamp": {
        "description": "Parse string to TIMESTAMP type",
        "formats": ["yyyy-MM-dd HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss", "yyyy-MM-dd'T'HH:mm:ss.SSS", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "MM/dd/yyyy HH:mm:ss"]
      },
      "cast_string": {"description": "Cast to STRING type"},
      "cast_int": {"description": "Cast to INT type"},
      "cast_long": {"description": "Cast to LONG type"},
      "cast_boolean": {
        "description": "Normalize various boolean representations",
        "true_values": ["TRUE", "1", "Y", "YES"],
        "false_values": ["FALSE", "0", "N", "NO"]
      }
    }
  },

  "sources": {
    "greenplum": {
      "enabled": true,
      "table_name": "rdl_customer_hist_st",
      "view_name": "gp_customer_v",
      "flow_name": "gp_to_unified_flow",
      "description": "Greenplum legacy customer history - oldest data, one-time load",
      "source_system_value": "greenplum",
      "exclude_columns": ["is_current"],
      "column_mapping": {
        "customer_id":            {"source_col": "customer_id",         "transform": null},
        "customer_name":          {"source_col": "customer_name",       "transform": null},
        "date_of_birth":          {"source_col": "date_of_birth",       "transform": null},
        "email":                  {"source_col": "email",               "transform": null},
        "phone":                  {"source_col": "phone",               "transform": null},
        "state":                  {"source_col": "state",               "transform": null},
        "zip_code":               {"source_col": "zip_code",            "transform": null},
        "status":                 {"source_col": "status",              "transform": null},
        "last_login":             {"source_col": "last_login",          "transform": null},
        "session_count":          {"source_col": "session_count",       "transform": null},
        "page_views":             {"source_col": "page_views",          "transform": null},
        "is_deleted":             {"source_col": "is_deleted",          "transform": null},
        "event_timestamp":        {"source_col": "event_timestamp",     "transform": null},
        "ingestion_timestamp":    {"source_col": "ingestion_timestamp", "transform": null},
        "source_system":          {"source_col": null,                  "transform": null, "default": "greenplum"},
        "source_record_start_dt": {"source_col": "valid_from",          "transform": null},
        "source_record_end_dt":   {"source_col": "valid_to",            "transform": null},
        "_version":               {"source_col": "_version",            "transform": null}
      }
    },

    "sqlserver": {
      "enabled": true,
      "table_name": "rdl_customer_init_st",
      "view_name": "sql_customer_v",
      "flow_name": "sql_to_unified_flow",
      "description": "SQL Server initial customer snapshot - baseline state, one-time load",
      "source_system_value": "sqlserver",
      "exclude_columns": [],
      "column_mapping": {
        "customer_id":            {"source_col": "customer_id",         "transform": null},
        "customer_name":          {"source_col": "customer_name",       "transform": null},
        "date_of_birth":          {"source_col": "date_of_birth",       "transform": null},
        "email":                  {"source_col": "email",               "transform": null},
        "phone":                  {"source_col": "phone",               "transform": null},
        "state":                  {"source_col": "state",               "transform": null},
        "zip_code":               {"source_col": "zip_code",            "transform": null},
        "status":                 {"source_col": "status",              "transform": null},
        "last_login":             {"source_col": "last_login",          "transform": null},
        "session_count":          {"source_col": "session_count",       "transform": null},
        "page_views":             {"source_col": "page_views",          "transform": null},
        "is_deleted":             {"source_col": "is_deleted",          "transform": null},
        "event_timestamp":        {"source_col": "event_timestamp",     "transform": null},
        "ingestion_timestamp":    {"source_col": "ingestion_timestamp", "transform": null},
        "source_system":          {"source_col": null,                  "transform": null, "default": "sqlserver"},
        "source_record_start_dt": {"source_col": null,                  "transform": null, "default": null},
        "source_record_end_dt":   {"source_col": null,                  "transform": null, "default": null},
        "_version":               {"source_col": "_version",            "transform": null}
      }
    },

    "kafka_cdc": {
      "enabled": true,
      "table_name": "rdl_customer",
      "view_name": "cdc_customer_v",
      "flow_name": "cdc_to_unified_flow",
      "description": "Kafka CDC customer stream - ongoing real-time changes",
      "source_system_value": "kafka_cdc",
      "exclude_columns": [],
      "column_mapping": {
        "customer_id":            {"source_col": "customer_id",         "transform": null},
        "customer_name":          {"source_col": "customer_name",       "transform": null},
        "date_of_birth":          {"source_col": "date_of_birth",       "transform": null},
        "email":                  {"source_col": "email",               "transform": null},
        "phone":                  {"source_col": "phone",               "transform": null},
        "state":                  {"source_col": "state",               "transform": null},
        "zip_code":               {"source_col": "zip_code",            "transform": null},
        "status":                 {"source_col": "status",              "transform": null},
        "last_login":             {"source_col": "last_login",          "transform": null},
        "session_count":          {"source_col": "session_count",       "transform": null},
        "page_views":             {"source_col": "page_views",          "transform": null},
        "is_deleted":             {"source_col": "is_deleted",          "transform": null},
        "event_timestamp":        {"source_col": "event_timestamp",     "transform": null},
        "ingestion_timestamp":    {"source_col": "ingestion_timestamp", "transform": null},
        "source_system":          {"source_col": null,                  "transform": null, "default": "kafka_cdc"},
        "source_record_start_dt": {"source_col": null,                  "transform": null, "default": null},
        "source_record_end_dt":   {"source_col": null,                  "transform": null, "default": null},
        "_version":               {"source_col": "_version",            "transform": null}
      }
    }
  }
}
